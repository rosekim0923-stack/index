<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸµ íƒ€ì´ë° ë§ì¶”ê¸°</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:#07070f;color:#f0f0f0;font-family:'Noto Sans KR',sans-serif;
    min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px 16px;}
  .glow{position:fixed;inset:0;pointer-events:none;
    background:radial-gradient(ellipse at 50% 50%,rgba(255,77,109,0.07) 0%,transparent 70%);transition:background 0.5s;}
  body.win .glow{background:radial-gradient(ellipse at 50% 50%,rgba(248,195,44,0.22) 0%,transparent 55%);}
  body.lose .glow{background:radial-gradient(ellipse at 50% 50%,rgba(255,77,109,0.2) 0%,transparent 55%);}
  .wrap{position:relative;z-index:1;width:min(520px,100%);display:flex;flex-direction:column;align-items:center;gap:14px;}
  h1{font-family:'Black Han Sans',sans-serif;font-size:1.8rem;
    background:linear-gradient(135deg,#4cc9f0,#ff4d6d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;}
  .sub{color:#444;font-size:0.78rem;text-align:center;margin-top:-8px;}

  .page{width:100%;display:none;flex-direction:column;gap:12px;}
  .page.on{display:flex;}

  .btn{padding:11px 14px;border-radius:10px;border:1px solid #2a2a4a;background:#13131e;color:#f0f0f0;
    cursor:pointer;font-family:'Noto Sans KR',sans-serif;font-weight:700;font-size:0.85rem;transition:all 0.15s;}
  .btn:hover{border-color:#4cc9f0;}
  .brow{display:flex;gap:8px;width:100%;}
  .brow .btn{flex:1;}

  /* í™ˆ */
  .pick{background:#13131e;border:1px solid #222;border-radius:14px;padding:15px 18px;
    cursor:pointer;display:flex;align-items:center;gap:14px;transition:all 0.18s;}
  .pick:hover{border-color:#4cc9f0;transform:translateX(4px);}
  .pick.off{opacity:0.3;cursor:default;pointer-events:none;}
  .pe{font-size:1.5rem;flex-shrink:0;}
  .pi{flex:1;}
  .pn{font-weight:700;font-size:0.95rem;margin-bottom:3px;}
  .ps{font-size:0.72rem;color:#555;}
  .pb{font-size:0.68rem;padding:3px 10px;border-radius:20px;font-weight:700;flex-shrink:0;}
  .pg{background:rgba(123,237,159,0.12);color:#7bed9f;border:1px solid #7bed9f;}
  .py{background:rgba(248,195,44,0.1);color:#f8c32c;border:1px solid #f8c32c;}

  /* ì„¤ì • */
  .scard{background:#13131e;border:1px solid #222;border-radius:14px;overflow:hidden;}
  .sh{padding:13px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background 0.15s;}
  .sh:hover{background:#1a1a2e;}
  .sb{background:#0f0f18;border-top:1px solid #1a1a2e;padding:14px 16px;display:none;flex-direction:column;gap:11px;}
  .sb.open{display:flex;}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .lbl{font-size:0.72rem;color:#666;min-width:56px;}
  .fbtn{padding:7px 13px;border-radius:8px;border:1px dashed #2a2a4a;background:transparent;color:#777;
    cursor:pointer;font-family:'Noto Sans KR',sans-serif;font-size:0.78rem;font-weight:700;transition:all 0.15s;}
  .fbtn:hover{border-color:#4cc9f0;color:#4cc9f0;}
  .fbtn.ok{border-style:solid;border-color:#7bed9f;color:#7bed9f;}

  /* ë¯¸ë‹ˆ í”Œë ˆì´ì–´ */
  .mp{display:flex;align-items:center;gap:10px;}
  .mpp{width:34px;height:34px;border-radius:50%;border:none;background:#4cc9f0;color:#000;font-size:0.85rem;cursor:pointer;flex-shrink:0;}
  .mb{flex:1;height:6px;background:#222;border-radius:3px;cursor:pointer;position:relative;}
  .mf{height:100%;border-radius:3px;background:#4cc9f0;width:0%;}
  .mm{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;
    background:#f8c32c;box-shadow:0 0 6px #f8c32c;display:none;pointer-events:none;}
  .mt{font-size:0.7rem;color:#555;min-width:30px;text-align:right;}
  .mkbtn{padding:12px;border-radius:10px;border:2px solid #f8c32c;background:rgba(248,195,44,0.08);
    color:#f8c32c;font-family:'Black Han Sans',sans-serif;font-size:1rem;cursor:pointer;transition:all 0.1s;}
  .mkbtn:active{background:rgba(248,195,44,0.25);transform:scale(0.97);}

  /* ê²Œì„ */
  .nname{font-family:'Black Han Sans',sans-serif;font-size:1.3rem;color:#4cc9f0;text-align:center;}
  .pbar{width:100%;background:#13131e;border:1px solid #1e1e3a;border-radius:12px;
    padding:12px 16px;display:flex;align-items:center;gap:12px;}
  #pp{width:40px;height:40px;border-radius:50%;border:none;background:#ff4d6d;color:#fff;font-size:1rem;cursor:pointer;flex-shrink:0;}
  .pw{flex:1;height:7px;background:#222;border-radius:4px;cursor:pointer;position:relative;}
  .pf{height:100%;border-radius:4px;background:linear-gradient(90deg,#4cc9f0,#ff4d6d);width:0%;}
  .pm{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;
    background:#f8c32c;box-shadow:0 0 8px #f8c32c;pointer-events:none;}
  #at{font-size:0.75rem;color:#555;min-width:36px;text-align:right;}
  #gs{font-family:'Black Han Sans',sans-serif;font-size:1rem;color:#555;text-align:center;min-height:1.4rem;}

  #hb{width:100%;height:160px;border-radius:22px;background:#13131e;border:2px solid #2a2a4a;cursor:pointer;
    font-family:'Black Han Sans',sans-serif;font-size:2.4rem;color:#f0f0f0;
    transition:all 0.07s;user-select:none;position:relative;overflow:hidden;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;}
  #hb small{font-size:0.75rem;color:#444;font-family:'Noto Sans KR',sans-serif;font-weight:400;}
  #hb::before{content:'';position:absolute;inset:0;
    background:radial-gradient(circle at center,rgba(255,77,109,0.3),transparent 65%);opacity:0;transition:opacity 0.07s;}
  #hb.pr::before{opacity:1;}
  #hb.pr{border-color:#ff4d6d;transform:scale(0.97);box-shadow:0 0 50px rgba(255,77,109,0.5);}
  #hb:disabled{opacity:0.25;cursor:default;}
  #hb.rd{border-color:#4cc9f0;animation:rp 1.4s ease-in-out infinite;}
  @keyframes rp{0%,100%{box-shadow:0 0 15px rgba(76,201,240,0.2)}50%{box-shadow:0 0 45px rgba(76,201,240,0.55)}}

  #res{width:100%;background:#13131e;border:1px solid #222;border-radius:16px;padding:26px;text-align:center;display:none;}
  #res.on{display:block;}
  #rg{font-family:'Black Han Sans',sans-serif;font-size:2.4rem;margin-bottom:6px;}
  #rt{font-size:0.88rem;color:#aaa;margin-bottom:6px;}
  #rc{font-family:'Black Han Sans',sans-serif;font-size:1.1rem;}

  #recs{width:100%;display:none;flex-direction:column;gap:5px;}
  #recs.on{display:flex;}
  .rtit{font-size:0.68rem;color:#333;font-weight:700;letter-spacing:0.06em;}
  .rr{display:flex;justify-content:space-between;align-items:center;
    background:#0f0f18;border-radius:8px;padding:7px 12px;font-size:0.8rem;}

  .fx{position:fixed;pointer-events:none;z-index:999;font-family:'Black Han Sans',sans-serif;font-size:2rem;
    animation:ff 0.7s ease-out forwards;}
  @keyframes ff{from{opacity:1;transform:translateY(0)scale(1)}to{opacity:0;transform:translateY(-90px)scale(1.6)}}

  /* íƒ€ì´ë° ë””ë²„ê·¸ í‘œì‹œ */
  #debug{font-size:0.72rem;color:#333;text-align:center;}
</style>
</head>
<body>
<div class="glow"></div>
<div class="wrap">
<h1>ğŸµ íƒ€ì´ë° ë§ì¶”ê¸°</h1>
<p class="sub">ì „ì£¼ ëë‚˜ê³  ë…¸ë˜ ì‹œì‘ë˜ëŠ” ìˆœê°„ ë”± í•œ ë²ˆ í´ë¦­!</p>

<!-- í™ˆ -->
<div class="page on" id="p-home"></div>

<!-- ì„¤ì • -->
<div class="page" id="p-setup">
  <div style="display:flex;align-items:center;gap:10px;width:100%">
    <span style="font-family:'Black Han Sans',sans-serif;font-size:1.1rem;color:#f8c32c;flex:1">ğŸ”§ ì„¤ì • ëª¨ë“œ</span>
    <button class="btn" onclick="page('home')">â† í™ˆ</button>
  </div>
  <div id="slist"></div>
</div>

<!-- ê²Œì„ -->
<div class="page" id="p-game">
  <div class="nname" id="nn"></div>
  <div class="pbar">
    <button id="pp" onclick="ppTap()">â–¶</button>
    <div class="pw" id="pw" onclick="seek(event)">
      <div class="pf" id="pf"></div>
      <div class="pm" id="pm"></div>
    </div>
    <div id="at">0:00</div>
  </div>
  <div id="gs">â–¶ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘!</div>
  <button id="hb" onclick="hit(event)" disabled>
    ğŸµ ë…¸ë˜ ì‹œì‘!
    <small>ìŠ¤í˜ì´ìŠ¤ë°”ë„ OK</small>
  </button>
  <div id="res"><div id="rg"></div><div id="rt"></div><div id="rc"></div></div>
  <div id="recs"><div class="rtit">ğŸ“Š ê¸°ë¡</div></div>
  <div id="debug"></div>
  <div class="brow">
    <button class="btn" onclick="resetGame()">ğŸ”„ ë‹¤ì‹œ</button>
    <button class="btn" onclick="page('home')">â† ê³¡ ëª©ë¡</button>
  </div>
</div>
</div>

<audio id="aud"></audio>
<audio id="sa"></audio>

<script>
// â•â• ê³¡ ëª©ë¡ â•â•
const SONGS = [
  {n:'ë°”ëŒì´ ë¶ˆì–´ì˜¤ëŠ” ê³³', e:'ğŸŒ¬ï¸'},
  {n:'ì•„ë¦„ë‹¤ìš´ ë‚˜ë¼',       e:'ğŸŒ¸'},
  {n:'ì‚¬ëŒì´ ê½ƒë³´ë‹¤ ì•„ë¦„ë‹¤ì›Œ', e:'ğŸŒº'},
  {n:"Clap Yo' Hands",    e:'ğŸ‘'},
  {n:'ë‚¨ì´Œ',               e:'ğŸ¡'},
];

// state[i] = { file: base64|null, vocal: number|null, marks: [] }
const S = SONGS.map(()=>({file:null,vocal:null,marks:[]}));

// â•â• í™”ë©´ ì „í™˜ â•â•
function page(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById('p-'+id).classList.add('on');
  if(id==='home') buildHome();
  if(id==='setup') buildSetup();
  document.body.className='';
}

// â•â• í™ˆ â•â•
function buildHome(){
  const w=document.getElementById('p-home');
  w.innerHTML='';
  SONGS.forEach((s,i)=>{
    const rdy=!!(S[i].file && S[i].vocal!==null);
    const d=document.createElement('div');
    d.className='pick'+(rdy?'':' off');
    d.innerHTML=`<span class="pe">${s.e}</span>
      <div class="pi"><div class="pn">${s.n}</div>
      <div class="ps">${rdy?'ì¤€ë¹„ ì™„ë£Œ â€” í´ë¦­í•´ì„œ ì‹œì‘':'ì„¤ì • ëª¨ë“œì—ì„œ íŒŒì¼Â·íƒ€ì´ë° ë“±ë¡ í•„ìš”'}</div></div>
      <span class="pb ${rdy?'pg':'py'}">${rdy?'âœ… ì¤€ë¹„':'âš™ï¸ ë¯¸ì„¤ì •'}</span>`;
    if(rdy) d.onclick=()=>startGame(i);
    w.appendChild(d);
  });
  // ì„¤ì • ë²„íŠ¼
  const sb=document.createElement('div');
  sb.className='pick';sb.style.borderStyle='dashed';sb.style.borderColor='#2a2a4a';
  sb.innerHTML=`<span class="pe">ğŸ”§</span>
    <div class="pi"><div class="pn" style="color:#f8c32c">ì„¤ì • ëª¨ë“œ</div>
    <div class="ps">íŒŒì¼ ë“±ë¡ Â· íƒ€ì´ë° ì„¤ì •</div></div>`;
  sb.onclick=()=>page('setup');
  w.appendChild(sb);
}

// â•â• ì„¤ì • â•â•
let sa=document.getElementById('sa');
let si=-1; // ì„¤ì • ì¬ìƒ ì¤‘ì¸ ê³¡ ì¸ë±ìŠ¤
let sraf=null;

function buildSetup(){
  const w=document.getElementById('slist');
  w.innerHTML='';
  SONGS.forEach((s,i)=>{
    const st=S[i];
    const rdy=!!(st.file&&st.vocal!==null);
    const c=document.createElement('div');
    c.className='scard';
    c.innerHTML=`
      <div class="sh" onclick="toggleBody(${i})">
        <span style="font-size:1.3rem;flex-shrink:0">${s.e}</span>
        <span style="font-weight:700;font-size:0.92rem;flex:1">${s.n}</span>
        <span style="font-size:0.7rem;padding:3px 9px;border-radius:12px;font-weight:700;
          ${rdy?'background:rgba(123,237,159,0.12);color:#7bed9f;border:1px solid #7bed9f'
               :'background:rgba(248,195,44,0.1);color:#f8c32c;border:1px solid #f8c32c'}">
          ${rdy?'âœ… ì¤€ë¹„':'âš™ï¸ ì„¤ì •í•„ìš”'}</span>
      </div>
      <div class="sb" id="sb${i}">
        <div class="row">
          <span class="lbl">ìŒì•…íŒŒì¼</span>
          <button class="fbtn ${st.file?'ok':''}" onclick="document.getElementById('fi${i}').click()">
            ${st.file?'âœ… ë³€ê²½':'ğŸ“‚ íŒŒì¼ì„ íƒ'}</button>
          <input type="file" id="fi${i}" accept="audio/*" style="display:none" onchange="loadF(event,${i})">
          <span style="font-size:0.72rem;color:#7bed9f">${st.file?'ë“±ë¡ë¨':''}</span>
        </div>
        ${st.file?`
        <div style="font-size:0.72rem;color:#f8c32c;font-weight:700">â±ï¸ ë…¸ë˜ ì‹œì‘ íƒ€ì´ë°</div>
        <div style="font-size:0.7rem;color:#555">â–¶ ì¬ìƒ â†’ ë…¸ë˜ ì‹œì‘ë˜ëŠ” ìˆœê°„ ì•„ë˜ ë²„íŠ¼ í´ë¦­!</div>
        <div class="mp">
          <button class="mpp" id="mpp${i}" onclick="toggleSa(${i})">â–¶</button>
          <div class="mb" id="mb${i}" onclick="seekSa(event,${i})">
            <div class="mf" id="mf${i}"></div>
            <div class="mm" id="mm${i}"></div>
          </div>
          <span class="mt" id="mt${i}">0:00</span>
        </div>
        <button class="mkbtn" onclick="mark(${i})">ğŸµ ì§€ê¸ˆì´ì•¼! â€” ë…¸ë˜ ì‹œì‘ ìˆœê°„ í´ë¦­</button>
        <div id="mi${i}" style="font-size:0.78rem;font-weight:700;color:#7bed9f;margin-top:2px">
          ${st.vocal!==null?'âœ… ì„¤ì •ê°’: '+st.vocal.toFixed(3)+'ì´ˆ ('+st.marks.length+'ë²ˆ í‰ê· )':''}</div>
        `:`<div style="font-size:0.74rem;color:#444">íŒŒì¼ ë¨¼ì € ì„ íƒ í›„ íƒ€ì´ë° ì„¤ì • ê°€ëŠ¥</div>`}
      </div>`;
    w.appendChild(c);
  });
}

function toggleBody(i){document.getElementById('sb'+i).classList.toggle('open');}

function loadF(e,i){
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    S[i].file=ev.target.result;
    S[i].vocal=null;
    S[i].marks=[];
    buildSetup();
    setTimeout(()=>document.getElementById('sb'+i)?.classList.add('open'),50);
  };
  r.readAsDataURL(f);
}

function toggleSa(i){
  if(si!==i){sa.pause();stopSraf();sa.src=S[i].file;sa.load();si=i;S[i].marks=[];}
  if(sa.paused){sa.play();document.getElementById('mpp'+i).textContent='â¸';startSraf(i);}
  else{sa.pause();document.getElementById('mpp'+i).textContent='â–¶';stopSraf();}
}
function seekSa(e,i){
  if(!sa.duration||si!==i)return;
  const r=document.getElementById('mb'+i).getBoundingClientRect();
  sa.currentTime=((e.clientX-r.left)/r.width)*sa.duration;
}
function startSraf(i){
  function loop(){
    if(sa.duration){
      const p=sa.currentTime/sa.duration*100;
      const f=document.getElementById('mf'+i);if(f)f.style.width=p+'%';
      const t=document.getElementById('mt'+i);
      if(t){const m=Math.floor(sa.currentTime/60),s=Math.floor(sa.currentTime%60).toString().padStart(2,'0');t.textContent=m+':'+s;}
    }
    sraf=requestAnimationFrame(loop);
  }
  loop();
}
function stopSraf(){if(sraf){cancelAnimationFrame(sraf);sraf=null;}}

function mark(i){
  // ì¬ìƒ ì¤‘ì´ ì•„ë‹ˆë©´ ì¬ìƒë¶€í„°
  if(si!==i||sa.paused){toggleSa(i);return;}
  const t=sa.currentTime;
  S[i].marks.push(t);
  const avg=S[i].marks.reduce((a,b)=>a+b,0)/S[i].marks.length;
  S[i].vocal=parseFloat(avg.toFixed(3));
  // ë§ˆì»¤ í‘œì‹œ
  if(sa.duration){const mm=document.getElementById('mm'+i);if(mm){mm.style.left=(t/sa.duration*100)+'%';mm.style.display='block';}}
  // ê²°ê³¼ í‘œì‹œ
  const mi=document.getElementById('mi'+i);
  if(mi)mi.textContent=`âœ… ì„¤ì •ê°’: ${S[i].vocal.toFixed(3)}ì´ˆ (${S[i].marks.length}ë²ˆ í‰ê· )`;
  // 4ì´ˆ ì „ìœ¼ë¡œ
  sa.currentTime=Math.max(0,t-4);
  console.log(`[mark] ê³¡${i} â†’ vocal=${S[i].vocal}`);
}

// â•â• ê²Œì„ â•â•
const aud=document.getElementById('aud');
let gi=-1;       // í˜„ì¬ ê²Œì„ ì¤‘ì¸ ê³¡ ì¸ë±ìŠ¤
let gOn=false;   // ì¬ìƒ ì¤‘
let gDone=false; // ì´ë¯¸ í´ë¦­í•¨
let gRaf=null;
let recs=[];

function startGame(i){
  // íƒ€ì´ë°ì´ ì„¤ì •ëëŠ”ì§€ ìµœì¢… í™•ì¸
  if(S[i].vocal===null){alert('íƒ€ì´ë°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');return;}
  gi=i;
  aud.src=S[i].file;
  aud.load();
  document.getElementById('nn').textContent=SONGS[i].e+' '+SONGS[i].n;
  aud.addEventListener('loadedmetadata',()=>{
    if(aud.duration){
      document.getElementById('pm').style.left=(S[i].vocal/aud.duration*100)+'%';
    }
  },{once:true});
  resetGame();
  page('game');
  console.log(`[startGame] ê³¡${i} vocal=${S[i].vocal}`);
}

function ppTap(){
  if(aud.paused){
    aud.play();
    document.getElementById('pp').textContent='â¸';
    document.getElementById('gs').textContent='ğŸµ ì „ì£¼ ë“£ëŠ” ì¤‘... ë…¸ë˜ ì‹œì‘ë˜ë©´ í´ë¦­!';
    document.getElementById('gs').style.color='#4cc9f0';
    document.getElementById('hb').disabled=false;
    document.getElementById('hb').classList.add('rd');
    gOn=true;
    startGraf();
  }else{
    aud.pause();
    document.getElementById('pp').textContent='â–¶';
    document.getElementById('gs').textContent='ì¼ì‹œì •ì§€';
    document.getElementById('gs').style.color='#555';
    stopGraf();
  }
}
function seek(e){
  if(!aud.duration)return;
  const r=document.getElementById('pw').getBoundingClientRect();
  aud.currentTime=((e.clientX-r.left)/r.width)*aud.duration;
}
function startGraf(){
  function loop(){
    if(aud.duration){
      document.getElementById('pf').style.width=(aud.currentTime/aud.duration*100)+'%';
      const m=Math.floor(aud.currentTime/60),s=Math.floor(aud.currentTime%60).toString().padStart(2,'0');
      document.getElementById('at').textContent=m+':'+s;
    }
    gRaf=requestAnimationFrame(loop);
  }
  loop();
}
function stopGraf(){if(gRaf){cancelAnimationFrame(gRaf);gRaf=null;}}

function hit(e){
  if(!gOn||gDone)return;
  gDone=true;

  const ct=aud.currentTime;               // ë‚´ê°€ í´ë¦­í•œ ì‹œê°„
  const vocal=S[gi].vocal;                // ë…¸ë˜ ì‹œì‘ ì‹œê°„
  const diff=ct-vocal;                    // ì–‘ìˆ˜=ëŠ¦ìŒ, ìŒìˆ˜=ë¹ ë¦„
  const abs=Math.abs(diff)*1000;          // ms ë‹¨ìœ„

  console.log(`[hit] ct=${ct.toFixed(3)} vocal=${vocal} diff=${diff.toFixed(3)}s abs=${abs.toFixed(0)}ms`);

  const btn=document.getElementById('hb');
  btn.classList.add('pr');btn.classList.remove('rd');
  setTimeout(()=>btn.classList.remove('pr'),100);
  btn.disabled=true;

  const g=getGrade(abs);
  spawnFx(window.innerWidth/2,window.innerHeight*0.5,g.emoji);
  showRes(diff,abs,g);
  recs.unshift({diff,abs,g});
  if(recs.length>5)recs.pop();
  showRecs();

  // ë””ë²„ê·¸ í‘œì‹œ (ì‹¤ì œ ì‚¬ìš©ì‹œ ì§€ìš°ë ¤ë©´ ì£¼ì„ì²˜ë¦¬)
  document.getElementById('debug').textContent=
    `í´ë¦­: ${ct.toFixed(2)}s | ë…¸ë˜ì‹œì‘: ${vocal.toFixed(2)}s | ì°¨ì´: ${diff>0?'+':''}${(diff*1000).toFixed(0)}ms`;

  document.body.className=abs<=500?'win':'lose';
}

function getGrade(absMs){
  if(absMs<=200) return{label:'PERFECT',emoji:'â­',color:'#f8c32c',msg:'ì™„ë²½!! íƒ€ì´ë° ì²œì¬ ğŸ‰'};
  if(absMs<=500) return{label:'GREAT',  emoji:'ğŸ¯',color:'#4cc9f0',msg:'ì•„ì£¼ ì¢‹ì•„ìš”!'};
  if(absMs<=1000)return{label:'GOOD',   emoji:'âœ¨',color:'#7bed9f',msg:'ê´œì°®ì•„ìš”!'};
  if(absMs<=2000)return{label:'OK',     emoji:'ğŸ‘',color:'#aaa',   msg:'ì¡°ê¸ˆ ë” ì—°ìŠµ!'};
  return              {label:'MISS',    emoji:'ğŸ’¨',color:'#ff4d6d',msg:'íƒ€ì´ë° ë†“ì³¤ì–´ìš”...'};
}

function showRes(diff,absMs,g){
  const dir=diff>0?`${(absMs/1000).toFixed(2)}ì´ˆ ëŠ¦ê²Œ`:`${(absMs/1000).toFixed(2)}ì´ˆ ë¹ ë¥´ê²Œ`;
  document.getElementById('rg').textContent=g.emoji+' '+g.label;
  document.getElementById('rg').style.color=g.color;
  document.getElementById('rt').textContent=`ë…¸ë˜ ì‹œì‘ë³´ë‹¤ ${dir} í´ë¦­ (${absMs.toFixed(0)}ms)`;
  document.getElementById('rc').textContent=g.msg;
  document.getElementById('rc').style.color=g.color;
  document.getElementById('res').classList.add('on');
  document.getElementById('gs').textContent=g.msg;
  document.getElementById('gs').style.color=g.color;
}

function showRecs(){
  const w=document.getElementById('recs');w.classList.add('on');
  w.querySelectorAll('.rr').forEach(e=>e.remove());
  recs.forEach((r,i)=>{
    const dir=r.diff>0?`${(r.abs/1000).toFixed(2)}s ëŠ¦ìŒ`:`${(r.abs/1000).toFixed(2)}s ë¹ ë¦„`;
    const d=document.createElement('div');d.className='rr';
    d.innerHTML=`<span style="color:#333">#${i+1}</span><span>${r.g.emoji} ${r.g.label}</span>
      <span style="font-family:'Black Han Sans',sans-serif;color:${r.g.color}">${dir}</span>`;
    w.appendChild(d);
  });
}

function resetGame(){
  aud.pause();aud.currentTime=0;
  gOn=false;gDone=false;stopGraf();
  document.getElementById('pp').textContent='â–¶';
  document.getElementById('pf').style.width='0%';
  document.getElementById('at').textContent='0:00';
  document.getElementById('hb').disabled=true;
  document.getElementById('hb').classList.remove('rd','pr');
  document.getElementById('res').classList.remove('on');
  document.getElementById('gs').textContent='â–¶ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘!';
  document.getElementById('gs').style.color='#555';
  document.getElementById('debug').textContent='';
  document.body.className='';
}

document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();hit(e);}});

function spawnFx(x,y,t){
  const d=document.createElement('div');d.className='fx';
  d.textContent=t;d.style.left=x+'px';d.style.top=y+'px';
  document.body.appendChild(d);setTimeout(()=>d.remove(),800);
}

buildHome();
</script>
</body>
</html>
